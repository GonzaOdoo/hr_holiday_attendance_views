<odoo>
  <template id="leave_form_custom" name="Formulario de Ausencia Personalizado">
           <t t-call="website.layout">
      <div id="balances-data" t-att-data-balances="balances" style="display: none;"/>
      <div class="container mt-4">

        <h2 class="mb-4">Solicitud de Tiempo Personal</h2>

        <t t-if="error">
          <div class="alert alert-danger" role="alert">
            <t t-esc="error"/>
          </div>
        </t>

        <form method="post" action="/permisos/submit" enctype="multipart/form-data">
          <!-- Empleado (solo lectura, es el del usuario) -->
          <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">Empleado</label>
            <div class="col-sm-9">
              <input type="text" class="form-control" t-att-value="leave.employee_id.name" readonly="1"/>
              <input type="hidden" name="employee_id" t-att-value="leave.employee_id.id"/>
            </div>
          </div>

          

          <!-- Tipo de ausencia -->
          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">Tipo de tiempo personal <span class="text-danger">*</span></label>
            <div class="col-sm-9">
              <select name="holiday_status_id" class="form-select" required="1">
                <option value="">-- Seleccione --</option>
                <t t-foreach="leave_types" t-as="lt">
                  <option t-att-value="lt.id" t-att-selected="leave.holiday_status_id.id == lt.id">
                    <t t-esc="lt.name"/>
                  </option>
                </t>
              </select>
            </div>
          </div>
          <div id="saldo-dinamico" class="mb-3 row" style="display:none;">
              <div class="col-sm-9 offset-sm-3">
                <div class="alert alert-info">
                  <strong>Saldo:</strong> <span id="saldo-texto"/>
                </div>
              </div>
            </div>
          <div id="tipo-reposo-field" class="mb-2 row" style="display:none;">
              <label class="col-sm-3 col-form-label">Tipo de reposo <span class="text-danger">*</span></label>
              <div class="col-sm-9">
                <select name="tipo_enfermedad" class="form-select">
                  <option value="">-- Seleccione --</option>
                  <option value="ips">Con reposo IPS</option>
                  <option value="privado">Con reposo privado</option>
                </select>
              </div>
            </div>
            <div class="text-center">
                <button type="button" class="btn btn-secondary btn-sm mb-2" id="open-balances-modal" style="padding:5px;">
                    Ver todos los disponibles
                </button>
            </div>
          <!-- Mostrar saldo SOLO si ya se eligió un tipo -->
          

          <!-- Fechas -->
          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">Fecha <span class="text-danger">*</span></label>
            <div class="col-sm-4">
                <label class="form-label small">Desde</label>
                <input type="date" name="request_date_from" class="form-control" t-att-value="leave.request_date_from"/>
            </div>
            <div class="col-sm-4">
                <label class="form-label small">Hasta</label>
                <input type="date" name="request_date_to" class="form-control" t-att-value="leave.request_date_to"/>
            </div>
        </div>

          <!-- Horas personalizadas 
          <div class="mb-3 form-check">
            <input class="form-check-input" type="checkbox" name="request_unit_hours" id="request_unit_hours" t-att-checked="leave.request_unit_hours"/>
            <label class="form-check-label" for="request_unit_hours">Horas personalizadas</label>
          </div>

          <div id="horas-personalizadas-field" class="mb-3 row" style="display:none;">
              <label class="col-sm-3 col-form-label">Hora desde</label>
              <div class="col-sm-3">
                <input type="number" step="0.01" name="request_hour_from" class="form-control" t-att-value="leave.request_hour_from"/>
              </div>
              <label class="col-sm-3 col-form-label">Hora hasta</label>
              <div class="col-sm-3">
                <input type="number" step="0.01" name="request_hour_to" class="form-control" t-att-value="leave.request_hour_to"/>
              </div>
            </div>
            -->
          <!-- Descripción -->
          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">Descripción</label>
            <div class="col-sm-9">
              <input type="text" name="name" class="form-control" t-att-value="leave.name"/>
            </div>
          </div>
          
         <!-- Reemplazante -->
          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">Reemplazante</label>
            <div class="col-sm-9">
              <select name="replacement" class="form-select">
                <option value="">-- Ninguno --</option>
                <t t-foreach="employees" t-as="emp">
                  <option t-att-value="emp.id" t-att-selected="leave.replacement.id == emp.id">
                    <t t-esc="emp.name"/>
                  </option>
                </t>
              </select>
            </div>
          </div>
          
          <!-- Adjunto -->
          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">Justificante</label>
            <div class="col-sm-9">
              <input type="file" name="attachment_ids" class="form-control"/>
            </div>
          </div>

          <!-- Botón -->
          <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary">Enviar Solicitud</button>
          </div>
        </form>
      </div>
       
   
      
 

<!-- Popup (modal) oculto por defecto -->
<div id="balances-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
  <div style="background: white; padding: 20px; border-radius: 8px; max-width: 70vw; width: 90%; max-height: 80vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h5 style="margin: 0;">Saldos disponibles</h5>
      <button type="button" class="btn-close" id="close-balances-modal" aria-label="Close"/>
    </div>
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Total</th>
          <th>Tomados</th>
          <th>Restantes</th>
        </tr>
      </thead>
      <tbody>
        <t t-foreach="leave_types" t-as="lt">
          <t t-set="b" t-value="balances.get(lt.id, {})"/>
          <tr>
            <td><t t-esc="lt.name"/></td>
            <td><t t-esc="b.get('max_leaves', 'N/A')"/></td>
            <td><t t-esc="b.get('leaves_taken', 'N/A')"/></td>
            <td><strong><t t-esc="b.get('virtual_remaining_leaves', 'N/A')"/></strong></td>
          </tr>
        </t>
      </tbody>
    </table>
    <div class="text-end mt-2">
      <button class="btn btn-secondary btn-sm" id="close-balances-modal-2">Cerrar</button>
    </div>
  </div>
</div>



<script>
    
  document.addEventListener('DOMContentLoaded', function () {
    const openBtn = document.getElementById('open-balances-modal');
    const closeBtns = document.querySelectorAll('#close-balances-modal, #close-balances-modal-2');
    const modal = document.getElementById('balances-modal');

    if (openBtn) {
      openBtn.addEventListener('click', function () {
        modal.style.display = 'flex';
      });
    }

    closeBtns.forEach(btn =&gt; {
      btn.addEventListener('click', function () {
        modal.style.display = 'none';
      });
    });

    // Opcional: cerrar al hacer clic fuera del contenido
    modal.addEventListener('click', function (e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
  
    const balances = <t t-raw="balances_json"/>;
    console.log('Balances:',balances);
    const leaveTypeSelect = document.querySelector('select[name="holiday_status_id"]');
    const tipoReposoField = document.getElementById('tipo-reposo-field');
    const saldoDiv = document.getElementById('saldo-dinamico');
    const saldoTexto = document.getElementById('saldo-texto');

    
    function actualizarSaldo(){
        if (balances[leaveTypeSelect.value]) {
          const b = balances[leaveTypeSelect.value];
          let texto = `Total: ${b.max_leaves} | Tomados: ${b.leaves_taken} | Restantes: ${b.virtual_remaining_leaves}`;
          console.log(texto)
          if (b.max_leaves != 'N/A'){
              saldoTexto.textContent = texto;
              saldoDiv.style.display = 'block';
          }
          else{
            saldoDiv.style.display = 'none';
          }
        } else {
          saldoDiv.style.display = 'none';
        }

    }
    
    if (!leaveTypeSelect || !tipoReposoField) return;

    function toggleTipoReposo() {
      if (leaveTypeSelect.value === '2') {
        tipoReposoField.style.display = 'flex';
        tipoReposoField.style.flexDirection = 'row';
        tipoReposoField.style.alignItems = 'center';
      } else {
        tipoReposoField.style.display = 'none';
        // Opcional: limpiar el valor si se oculta
        tipoReposoField.querySelector('select').value = '';
      }
    }

    // Ejecutar al cargar (por si ya hay un valor preseleccionado)
    toggleTipoReposo();
    actualizarSaldo()

    // Escuchar cambios
    leaveTypeSelect.addEventListener('change', toggleTipoReposo);
    leaveTypeSelect.addEventListener('change', actualizarSaldo);
  });
</script>
    </t>
  </template>





    <template id="my_leaves_list" name="Mis Permisos">
        <t t-call="website.layout">
            <t t-set="additional_title">Mis Permisos</t>
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container mt-4 mb-5">
                    <h2 class="mb-4">Mis solicitudes de permiso</h2>

                    <!-- Barra de búsqueda y filtros -->
                    <div class="d-flex flex-wrap gap-3 mb-4">
                        <!-- Búsqueda por texto -->
                        <form method="get" class="d-flex">
                            <input type="text" name="search" t-att-value="search"
                                   placeholder="Buscar por tipo o motivo..." class="form-control me-2"/>
                            <button type="submit" class="btn btn-outline-secondary">Buscar</button>
                        </form>

                        <!-- Filtro por estado -->
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown">
                                <i class="fa fa-filter me-1"></i>
                                Estado: <t t-if="current_state" t-out="state_options.get(current_state, current_state)"/>
                                <t t-else="">Todos</t>
                            </button>
                            <ul class="dropdown-menu">
                                <t t-foreach="state_options.items()" t-as="opt">
                                    <li>
                                        <a class="dropdown-item" t-att-href="'?%s' % keep_query('search', 'date_from', 'date_to', state=opt[0])">
                                            <t t-out="opt[1]"/>
                                        </a>
                                    </li>
                                </t>
                            </ul>
                        </div>

                        <!-- Filtros por fecha (opcional) -->
                        <form method="get" class="d-flex gap-2">
                            <input type="date" name="date_from" t-att-value="date_from" class="form-control" style="width:auto;"/>
                            <input type="date" name="date_to" t-att-value="date_to" class="form-control" style="width:auto;"/>
                            <input type="hidden" name="search" t-att-value="search"/>
                            <input type="hidden" name="state" t-att-value="current_state"/>
                            <button type="submit" class="btn btn-outline-secondary">Filtrar fechas</button>
                        </form>
                    </div>

                    <!-- Lista de solicitudes -->
                    <t t-if="not leaves">
                        <div class="alert alert-info">
                            No se encontraron solicitudes de permiso.
                        </div>
                    </t>
                    <t t-else="">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Tipo de permiso</th>
                                        <th>Fecha(s)</th>
                                        <th>Estado</th>
                                        <th>Motivo</th>
                                        <th>Días</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="leaves" t-as="leave">
                                        <tr>
                                            <td><t t-out="leave.holiday_status_id.name"/></td>
                                            <td>
                                                <t t-if="leave.request_date_from == leave.request_date_to">
                                                    <t t-out="leave.request_date_from"/>
                                                </t>
                                                <t t-else="">
                                                    <t t-out="leave.request_date_from"/> – <t t-out="leave.request_date_to"/>
                                                </t>
                                            </td>
                                            <td>
                                                <span t-att-class="{
                                                    'badge bg-warning': leave.state == 'confirm',
                                                    'badge bg-success': leave.state == 'validate',
                                                    'badge bg-danger': leave.state == 'refuse',
                                                    'badge bg-secondary': leave.state == 'cancel'
                                                }">
                                                    <t t-if="leave.state == 'confirm'">Pendiente</t>
                                                    <t t-if="leave.state == 'validate'">Aprobado</t>
                                                    <t t-if="leave.state == 'refuse'">Rechazado</t>
                                                    <t t-if="leave.state == 'cancel'">Cancelado</t>
                                                </span>
                                            </td>
                                            <td><t t-out="leave.reason_text or '—'"/></td>
                                            <td><t t-out="round(leave.number_of_days, 2)"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </t>

                    <!-- Enlace para crear nuevo permiso -->
                    <div class="mt-4">
                        <a href="/permisos" class="btn btn-primary">
                            <i class="fa fa-plus me-1"></i> Solicitar nuevo permiso
                        </a>
                    </div>
                </div>
            </div>
        </t>
    </template>


    <template id="leave_success_page" name="Solicitud de Permiso Exitosa">
        <t t-call="website.layout">
            <div class="container mt-5">
                <div class="row justify-content-center">
                    <div class="col-md-8 text-center">
                        <h2 class="text-success">¡Solicitud creada con éxito!</h2>
                        <p class="lead">Su solicitud de permiso ha sido registrada correctamente.</p>
                        <a href="/mis-permisos" class="btn btn-primary mt-3">
                            Ver mis permisos
                        </a>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>